Improved diagnostics and error detection
